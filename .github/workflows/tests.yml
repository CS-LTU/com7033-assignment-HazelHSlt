# AI declaration:
# Github copilot was used for portions of the planning, research, feedback and editing of the software artefact. Mostly utilised for syntax, logic and error checking with ChatGPT and Claude Sonnet 4.5 used as the models.

# (Anthropic, 2025)
name: Healthcare Web App Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger.

  # (Anthropic, 2025)
jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up environment variables
      env:
        ENCRYPTION_KEY_SECRET: ${{ secrets.ENCRYPTION_KEY }} # Secret may not exist - intentional.
        SECRET_KEY_SECRET: ${{ secrets.SECRET_KEY }}
      run: |
        # Set encryption key with fallback to test key.
        if [ -z "$ENCRYPTION_KEY_SECRET" ]; then
          echo "ENCRYPTION_KEY=RNUId8QMEi_UY8gQokXN_VLGvTaiWViuldPc-4R0beU=" >> $GITHUB_ENV
        else
          echo "ENCRYPTION_KEY=$ENCRYPTION_KEY_SECRET" >> $GITHUB_ENV
        fi
        
        # Set secret key with fallback to test key
        if [ -z "$SECRET_KEY_SECRET" ]; then
          echo "SECRET_KEY=test_secret_key_for_testing_only" >> $GITHUB_ENV
        else
          echo "SECRET_KEY=$SECRET_KEY_SECRET" >> $GITHUB_ENV
        fi
        
        # Set Flask environment
        echo "FLASK_ENV=testing" >> $GITHUB_ENV
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-flask
    
    - name: Run security tests
      run: |
        pytest tests/test_security.py -v --cov=app.security --cov-report=term-missing
    
    - name: Run form validation tests
      run: |
        pytest tests/test_forms.py -v
    
    - name: Run model tests
      run: |
        pytest tests/test_models.py -v
    
    - name: Run authentication tests
      run: |
        pytest tests/test_auth.py -v
    
    - name: Run all tests with coverage
      run: |
        pytest tests/ -v --cov=app --cov-report=term-missing --cov-report=html
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      if: matrix.python-version == '3.11'
      with:
        name: coverage-report
        path: htmlcov/
    
    - name: Test summary
      if: always()
      run: |
        echo "Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Security tests completed" >> $GITHUB_STEP_SUMMARY
        echo "Form validation tests completed" >> $GITHUB_STEP_SUMMARY
        echo "Model tests completed" >> $GITHUB_STEP_SUMMARY
        echo "Authentication tests completed" >> $GITHUB_STEP_SUMMARY

