<!--
AI declaration:
Github copilot was used for portions of the planning, research, feedback and editing of the software artefact. Mostly utilised for syntax, logic and error checking with ChatGPT and Claude Sonnet 4.5 used as the models.

This HTML page is for the administrator dashboard form, using Jinja2 and py Flask templating, with Bootstrap 5 for styling, FontAwesome for icons, and Chart.js for data visualizations.

(Anthropic, 2025).
-->
{% extends "base.html" %}
{% block title %}Dashboard - Records Manager{% endblock %}

{% block extra_css %}
<style>
    /* Dashboard-specific styles only */
    .stats-panel {
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
    }
    
    .stat-card h3 {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .chart-container {
        height: 250px;
    }
    
    .records-panel {
        background-color: #fff;
        border-radius: 10px;
        padding: 20px;
    }
</style>
{% endblock %}
<!-- (Anthropic, 2025) -->
{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <h2 class="mb-3">
            <i class="fas fa-chart-line"></i> Patient Records Dashboard
        </h2>
        <div class="mb-3">
            <a href="{{ url_for('crud.create_patient') }}" class="btn btn-success">
                <i class="fas fa-plus-circle"></i> New Patient Record
            </a>
            <a href="{{ url_for('auth.userpage') }}" class="btn btn-info">
                <i class="fas fa-user-cog"></i> Account Settings
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Panel: Statistics and Visualizations, (Anthropic, 2025). -->
    <div class="col-lg-4 col-md-12">
        <div class="stats-panel">
            {% if stats and stats.total_records > 0 %}
            <!-- Total Records Card -->
            <div class="stat-card">
                <p class="mb-1"><i class="fas fa-database"></i> Total Records</p>
                <h3>{{ stats.total_records }}</h3>
                <small>Patients in database</small>
            </div>
            
            <!-- Stroke Risk Overview Card, (Anthropic, 2025). -->
            <div class="card mb-3">
                <div class="card-header bg-danger text-white">
                    <i class=""></i> Stroke Risk Overview
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="strokeChart"></canvas>
                    </div>
                    <div class="text-center mt-2">
                        <span class="badge bg-danger">{{ stats.stroke_count }} patients ({{ stats.stroke_percentage }}%)</span>
                        <span class="badge bg-success">{{ stats.no_stroke_count }} patients ({{ stats.no_stroke_percentage }}%)</span>
                    </div>
                </div>
            </div>
            
            <!-- Conditions Card, (Anthropic, 2025). -->
            <div class="card mb-3">
                <div class="card-header bg-warning text-dark">
                    <i class=""></i> Medical Conditions
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">Hypertension</small>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-warning" role="progressbar" 
                                 style="width: {{ stats.hypertension_percentage }}%">
                                {{ stats.hypertension_count }} ({{ stats.hypertension_percentage }}%)
                            </div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">Heart Disease</small>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-danger" role="progressbar" 
                                 style="width: {{ stats.heart_disease_percentage }}%">
                                {{ stats.heart_disease_count }} ({{ stats.heart_disease_percentage }}%)
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gender Distribution Card, (Anthropic, 2025). -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <i class=""></i> Gender Distribution
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="genderChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Smoking Status Card, (Anthropic, 2025). -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <i class=""></i> Smoking Status
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="smokingChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Age Distribution Card, (Anthropic, 2025). -->
            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">
                    <i class=""></i> Age Distribution
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="ageChart"></canvas>
                    </div>
                </div>
            </div>
            
            {% else %}
            <div class="alert alert-info">
                <i class=""></i> No data available for visualizations.
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Right Panel: Patient Records List, (Anthropic, 2025). -->
    <div class="col-lg-8 col-md-12">
        <div class="records-panel">
            <!-- Search and Filter Card, (Anthropic, 2025). -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-search"></i> Search & Filter
                </div>
                <div class="card-body">
                    <form method="GET" action="{{ url_for('crud.dashboard') }}" class="row g-3">
                        <div class="col-md-4">
                            {{ search_form.search_field.label(class="form-label") }}
                            {{ search_form.search_field(class="form-control") }}
                        </div>
                        <div class="col-md-4">
                            {{ search_form.search_value.label(class="form-label") }}
                            {{ search_form.search_value(class="form-control", placeholder="Enter search value") }}
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search"></i> Search
                            </button>
                            <a href="{{ url_for('crud.dashboard') }}" class="btn btn-secondary">
                                <i class="fas fa-redo"></i> Reset
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 
                Showing <strong>{{ records|length }}</strong> of <strong>{{ total }}</strong> total records
                {% if search_field and search_value %}
                    (filtered by {{ search_field }}: {{ search_value }})
                {% endif %}
            </div>
            
            <!-- Patient Records Table, (Anthropic, 2025). -->
            {% if records %}
            <div class="card">
                <div class="card-body table-responsive">
                    <table class="table table-hover table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Gender</th>
                                <th>Age</th>
                                <th>Hypertension</th>
                                <th>Heart Disease</th>
                                <th>Glucose</th>
                                <th>BMI</th>
                                <th>Smoking</th>
                                <th>Stroke</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in records %}
                            <tr>
                                <td>{{ record.id if record.id else 'N/A' }}</td>
                                <td>
                                    {% if record.gender == 'Male' %}
                                        <i class="fas fa-mars text-primary"></i>
                                    {% elif record.gender == 'Female' %}
                                        <i class="fas fa-venus text-danger"></i>
                                    {% else %}
                                        <i class="fas fa-genderless"></i>
                                    {% endif %}
                                </td>
                                <td>{{ record.age }}</td>
                                <td>
                                    {% if record.hypertension == 1 %}
                                        <span class="badge bg-warning">Yes</span>
                                    {% else %}
                                        <span class="badge bg-secondary">No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.heart_disease == 1 %}
                                        <span class="badge bg-warning">Yes</span>
                                    {% else %}
                                        <span class="badge bg-secondary">No</span>
                                    {% endif %}
                                </td>
                                <td>{{ "%.1f"|format(record.avg_glucose_level) }}</td>
                                <td>{{ record.bmi }}</td>
                                <td>
                                    {% if record.smoking_status == 'smokes' %}
                                        <span class="badge bg-danger">Smokes</span>
                                    {% elif record.smoking_status == 'formerly smoked' %}
                                        <span class="badge bg-warning">Former</span>
                                    {% elif record.smoking_status == 'never smoked' %}
                                        <span class="badge bg-success">Never</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Unknown</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.stroke == 1 %}
                                        <span class="badge bg-danger">Yes</span>
                                    {% else %}
                                        <span class="badge bg-success">No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{{ url_for('crud.view_patient', patient_id=record._id) }}" 
                                           class="btn btn-info" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="{{ url_for('crud.edit_patient', patient_id=record._id) }}" 
                                           class="btn btn-warning" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button type="button" class="btn btn-danger" 
                                                onclick="confirmDelete('{{ record._id }}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pagination, (Anthropic, 2025). -->
            {% if total_pages > 1 %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('crud.dashboard', page=page-1, search_field=search_field, search_value=search_value) }}">
                            Previous
                        </a>
                    </li>
                    {% endif %}
                    {% for p in range(1, total_pages + 1) %}
                        {% if p == page %}
                            <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                        {% elif p <= 3 or p > total_pages - 3 or (p >= page - 1 and p <= page + 1) %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('crud.dashboard', page=p, search_field=search_field, search_value=search_value) }}">{{ p }}</a>
                            </li>
                        {% elif p == 4 or p == total_pages - 3 %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endfor %}
                    {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('crud.dashboard', page=page+1, search_field=search_field, search_value=search_value) }}">
                            Next
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            
            {% else %}
            <div class="alert alert-warning text-center">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <h4>No Records Found</h4>
                <p>There are no patient records in the database. 
                   {% if total == 0 %}
                   CSV data will be imported automatically on next application restart, or you can 
                   {% endif %}
                   <a href="{{ url_for('crud.create_patient') }}" class="alert-link">create a new record</a>.
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal, (Anthropic, 2025). -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this patient record?</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js CDN, (Anthropic, 2025). -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    function confirmDelete(patientId) {
        const deleteForm = document.getElementById('deleteForm');
        deleteForm.action = `/patient/${patientId}/delete`;
        
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }
    
    {% if stats and stats.total_records > 0 %}
    // Chart.js Configuration, (Anthropic, 2025).
    Chart.defaults.font.family = 'Arial, sans-serif';
    Chart.defaults.color = '#666';
    
    // Stroke Distribution Pie Chart, (Anthropic, 2025).
    const strokeCtx = document.getElementById('strokeChart').getContext('2d');
    new Chart(strokeCtx, {
        type: 'doughnut',
        data: {
            labels: ['Stroke', 'No Stroke'],
            datasets: [{
                data: [{{ stats.stroke_count }}, {{ stats.no_stroke_count }}],
                backgroundColor: ['#e74c3c', '#27ae60'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            let value = context.parsed || 0;
                            let percentage = ((value / {{ stats.total_records }}) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // Gender Distribution Pie Chart, (Anthropic, 2025).
    const genderCtx = document.getElementById('genderChart').getContext('2d');
    new Chart(genderCtx, {
        type: 'pie',
        data: {
            labels: ['Male', 'Female', 'Other'],
            datasets: [{
                data: [
                    {{ stats.gender_counts.Male }}, 
                    {{ stats.gender_counts.Female }}, 
                    {{ stats.gender_counts.Other }}
                ],
                backgroundColor: ['#3498db', '#e74c3c', '#95a5a6'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Smoking Status Bar Chart, (Anthropic, 2025).
    const smokingCtx = document.getElementById('smokingChart').getContext('2d');
    new Chart(smokingCtx, {
        type: 'bar',
        data: {
            labels: ['Never', 'Former', 'Smokes', 'Unknown'],
            datasets: [{
                label: 'Patients',
                data: [
                    {{ stats.smoking_counts['never smoked'] }},
                    {{ stats.smoking_counts['formerly smoked'] }},
                    {{ stats.smoking_counts['smokes'] }},
                    {{ stats.smoking_counts['Unknown'] }}
                ],
                backgroundColor: ['#27ae60', '#f39c12', '#e74c3c', '#95a5a6'],
                borderWidth: 1,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    
    // Age Distribution Line Chart, (Anthropic, 2025).
    const ageCtx = document.getElementById('ageChart').getContext('2d');
    new Chart(ageCtx, {
        type: 'line',
        data: {
            labels: ['0-20', '21-40', '41-60', '61-80', '81+'],
            datasets: [{
                label: 'Patients',
                data: [
                    {{ stats.age_groups['0-20'] }},
                    {{ stats.age_groups['21-40'] }},
                    {{ stats.age_groups['41-60'] }},
                    {{ stats.age_groups['61-80'] }},
                    {{ stats.age_groups['81+'] }}
                ],
                backgroundColor: 'rgba(52, 152, 219, 0.2)',
                borderColor: '#3498db',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
    {% endif %}
</script>
{% endblock %}

